
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Worldpay Within website">
      
      
        <link rel="canonical" href="http://localhost:8000/architecture/">
      
      
        <meta name="author" content="Worldpay Within">
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.8.1">
    
    
      
        <title>Architecture - Worldpay Within</title>
      
    
    
      <script src="../assets/javascripts/modernizr-8210299719.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-6c83e613aa.css">
      
    
    
      
        <style>body,input{font-family:adelle_sansregular,"Helvetica Neue",Helvetica,Arial,sans-serif}h1,h2,h3,h4,h5,h6{font-family:adelle_sansthin,"Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="http://localhost:8000/" title="Worldpay Within" class="md-logo md-header-nav__button">
            <img src="../assets/images/logo.svg" width="160" height="32">
                <span class="md-subtitle">within</span>
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Architecture
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/szarych/wpw-doc-dev" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      szarych/wpw-doc-dev
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../assets/images/logo.svg" width="160" height="32">
        <span class="md-subtitle">within</span>
      </i>
    
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/szarych/wpw-doc-dev" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      szarych/wpw-doc-dev
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting started" class="md-nav__link">
      Getting started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../the-flows/" title="The Flows" class="md-nav__link">
      The Flows
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Architecture
      </label>
    
    <a href="./" title="Architecture" class="md-nav__link md-nav__link--active">
      Architecture
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-intro" title="Quick intro" class="md-nav__link">
    Quick intro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" title="Architecture Overview" class="md-nav__link">
    Architecture Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldpay-within-iot-service-architeture" title="Worldpay Within IoT Service Architeture" class="md-nav__link">
    Worldpay Within IoT Service Architeture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-discovery" title="Service Discovery" class="md-nav__link">
    Service Discovery
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service-discovery-apis" title="Service Discovery APIs" class="md-nav__link">
    Service Discovery APIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-discovery-messages" title="Service discovery messages" class="md-nav__link">
    Service discovery messages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service-negotiation" title="Service Negotiation" class="md-nav__link">
    Service Negotiation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-negotiation-apis" title="Service Negotiation APIs" class="md-nav__link">
    Service Negotiation APIs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-negotiation-messages" title="Service negotiation messages" class="md-nav__link">
    Service negotiation messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payment" title="Payment" class="md-nav__link">
    Payment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-token-request" title="Client token request" class="md-nav__link">
    Client token request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-token-request-apis" title="Client token request APIs" class="md-nav__link">
    Client token request APIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thing-a-to-onlineworldpaycom-client-token-request" title="Thing A to Online.worldpay.com client token request" class="md-nav__link">
    Thing A to Online.worldpay.com client token request
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payment-authorisation-request" title="Payment authorisation request" class="md-nav__link">
    Payment authorisation request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payment-authorisation-request-apis" title="Payment authorisation request APIs" class="md-nav__link">
    Payment authorisation request APIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thing-b-to-onlineworldpaycom-payment-authorisation-request" title="Thing B to Online.worldpay.com payment authorisation request" class="md-nav__link">
    Thing B to Online.worldpay.com payment authorisation request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thing-b-to-thing-a-service-token" title="Thing B to Thing A service token" class="md-nav__link">
    Thing B to Thing A service token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-delivery" title="Service Delivery" class="md-nav__link">
    Service Delivery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-delivery-apis" title="Service Delivery APIs" class="md-nav__link">
    Service Delivery APIs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#useful-terms" title="Useful terms" class="md-nav__link">
    Useful terms
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../atdc/" title="The Atlanta Fintech Hackathon" class="md-nav__link">
      The Atlanta Fintech Hackathon
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../documentation/" title="Documentation" class="md-nav__link">
      Documentation
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-intro" title="Quick intro" class="md-nav__link">
    Quick intro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" title="Architecture Overview" class="md-nav__link">
    Architecture Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worldpay-within-iot-service-architeture" title="Worldpay Within IoT Service Architeture" class="md-nav__link">
    Worldpay Within IoT Service Architeture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-discovery" title="Service Discovery" class="md-nav__link">
    Service Discovery
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service-discovery-apis" title="Service Discovery APIs" class="md-nav__link">
    Service Discovery APIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-discovery-messages" title="Service discovery messages" class="md-nav__link">
    Service discovery messages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service-negotiation" title="Service Negotiation" class="md-nav__link">
    Service Negotiation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-negotiation-apis" title="Service Negotiation APIs" class="md-nav__link">
    Service Negotiation APIs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-negotiation-messages" title="Service negotiation messages" class="md-nav__link">
    Service negotiation messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payment" title="Payment" class="md-nav__link">
    Payment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-token-request" title="Client token request" class="md-nav__link">
    Client token request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-token-request-apis" title="Client token request APIs" class="md-nav__link">
    Client token request APIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thing-a-to-onlineworldpaycom-client-token-request" title="Thing A to Online.worldpay.com client token request" class="md-nav__link">
    Thing A to Online.worldpay.com client token request
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payment-authorisation-request" title="Payment authorisation request" class="md-nav__link">
    Payment authorisation request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payment-authorisation-request-apis" title="Payment authorisation request APIs" class="md-nav__link">
    Payment authorisation request APIs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thing-b-to-onlineworldpaycom-payment-authorisation-request" title="Thing B to Online.worldpay.com payment authorisation request" class="md-nav__link">
    Thing B to Online.worldpay.com payment authorisation request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thing-b-to-thing-a-service-token" title="Thing B to Thing A service token" class="md-nav__link">
    Thing B to Thing A service token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-delivery" title="Service Delivery" class="md-nav__link">
    Service Delivery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-delivery-apis" title="Service Delivery APIs" class="md-nav__link">
    Service Delivery APIs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#useful-terms" title="Useful terms" class="md-nav__link">
    Useful terms
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/szarych/wpw-doc-dev/edit/master/docs/architecture.md" title="Edit this page" class="md-icon md-content__icon">edit</a>
                
                
                  <h1>Architecture</h1>
                
                <h3 id="quick-intro">Quick intro<a class="headerlink" href="#quick-intro" title="Permanent link">&para;</a></h3>
<p>To complement the Architecture we have released the Worldpay Within SDK. The intention for of the SDK is to encapsulate implementation and therefore assist third party vendors and developers in integration into their IoT solutions.</p>
<p>The core of the SDK is developed in the Go programming language with wrappers created for Java, Node.JS, Python 2.7, Pyhton 3.0 and .net(C#). Service delivery and broadcast have been implemented using TCP/IP networking.</p>
<p><a href="../sample-service-messaging.html">Please note the low level service messaging json spec can be found here</a></p>
<h3 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h3>
<p>In the IoT, each Thing will perform the function it is designed for be it acting as a sensor, or a controller or both. In order for Thing to be able to make and receive payments for services they can provide to other Things, they need to add the payments functionality contained in Worldpay Within.</p>
<p><img alt="Worldpay Within Pluggable agent" src="../images/architecture/worldpayWithinFig1.png" />
<figcaption>Figure 1. Worldpay Within Pluggable agent.</figcaption></p>
<p>Things in the IoT will be implemented on dedicated low cost processor systems. The Thing and Worldpay Within must co-exist and operate on the resources provided by these devices, as demonstrated in Figure 2.</p>
<p><img alt="Logical Overview" src="../images/architecture/logicalOverview.png" />
<figcaption>Figure 2. Worldpay Within Logical Overview.</figcaption></p>
<p>In order to make and receive payments in the IoT, a Thing must be able to perform the roles of “consumer”, to make a payment for services, and the “merchant”, to receive a payment for provision of services. In the Worldpay Within IoT architecture, the “consumer” pays for services by supporting Host Card Emulation (HCE). The “merchant” receives payments for services by supporting Host Terminal Emulation (HTE). Worldpay Within contains both an HCE Brain &amp; HTE Brain functionalities, ensuring a Thing can both consume and supply services. These services are provided through a series of public APIs, described within this document.</p>
<p>HCE and HTE require the secure storage and use of the credentials during the payments process. This necessitates the use of secure processing within the Thing in a “Secure Execution Environment”.</p>
<p>For HCE Things, these credentials include the details of the “card” which the payment will be made from. For HTE Things, these credentials include the details the Merchant requires to perform transactions in Online.worldpay.com.</p>
<p>As well as the provision of the payment for the services, Worldpay Within provides for the generation and validation of secure service tokens, which allow for services to be consumed in part or together, but separately from the payments functionality.</p>
<h3 id="worldpay-within-iot-service-architeture">Worldpay Within IoT Service Architeture<a class="headerlink" href="#worldpay-within-iot-service-architeture" title="Permanent link">&para;</a></h3>
<p>The provision of a service within the Worldpay IoT system is performed in 4 phases, as shown in Figure 4, these being: Service Discovery; Service Negotiation; Payment; and Service Delivery. Each of these phases are described in the following sections.</p>
<p><img alt="The 4 phases of Worldpay Within" src="../images/architecture/serviceOverview.png" />
<figcaption>Figure 4. The 4 phases of Worldpay Within.</figcaption></p>
<h4 id="service-discovery">Service Discovery<a class="headerlink" href="#service-discovery" title="Permanent link">&para;</a></h4>
<p>Each Thing that offers services, the service ‘supplier’ shall broadcast it’s list of available services, as shown in Figure 4 below. When a potential ‘consumer’ of the service connects with ‘supplier’ it can request details of the services offered.</p>
<p>Providing a suitable service is discovered, the consumer then requests the service from the supplier, and price negotiations can begin.</p>
<p><img alt="IoT Service discovery" src="../images/architecture/serviceDiscovery.png" />
<figcaption>Figure 5. IoT Service discovery.</figcaption></p>
<h3 id="service-discovery-apis">Service Discovery APIs<a class="headerlink" href="#service-discovery-apis" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Key</th>
<th>Parameters</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>broadcast</td>
<td>server_UUID</td>
<td>Advertising services and identifying the sender</td>
</tr>
<tr>
<td>request services</td>
<td>none</td>
<td>Request a list of all services</td>
</tr>
<tr>
<td>services_response</td>
<td>list of services, server_UUID</td>
<td>Provide client with a list of possible services that the sender can provide</td>
</tr>
</tbody>
</table>
<h4 id="service-discovery-messages">Service discovery messages<a class="headerlink" href="#service-discovery-messages" title="Permanent link">&para;</a></h4>
<p>A broadcast message that includes Thing B’s UUID is sent.</p>
<p>Upon receiving the message Thing A connects to Thing B and requests the list of available services.</p>
<p>Thing B responds with a list identifying the services available.</p>
<h2 id="service-negotiation">Service Negotiation<a class="headerlink" href="#service-negotiation" title="Permanent link">&para;</a></h2>
<p>Once a suitable service has been discovered, there will be a price negotiation. The provider may offer the same service at different rates depending on the number of units of service to be purchased. The process is outlined in Figure 5. The outcome of the process is an agreement to purchase an amount of service and a total price for the service to be provided. The service provider can then request payment for the agreed service and price.</p>
<p><img alt="IoT Service Negotiation" src="../images/architecture/serviceNegotiation.png" />
<figcaption>Figure 6. IoT Service Negotiation.</figcaption></p>
<h4 id="service-negotiation-apis">Service Negotiation APIs<a class="headerlink" href="#service-negotiation-apis" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Parameters</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>price_request</td>
<td>service_id</td>
<td>Request a list of all prices for a given service.</td>
</tr>
<tr>
<td>price_response</td>
<td>server_UUID, list of prices, (service_id, price_id, price_per_unit, unit_ID, unit_description, price_description)</td>
<td>Provide the client with a list of prices for a given service. A price object contains the per unit price.</td>
</tr>
<tr>
<td>price_select</td>
<td>service_id, price_id, number_of_units, client_UUID</td>
<td>Select a price with price_id, for service_id for a number of units.</td>
</tr>
<tr>
<td>price_select_response</td>
<td>price_id, number_of_units, total_price, server_UUID, client_UUID, payment_ref_ID, Merchant_Client_key</td>
<td>Communicate the expected total price to the client.</td>
</tr>
</tbody>
</table>
<h4 id="service-negotiation-messages">Service negotiation messages<a class="headerlink" href="#service-negotiation-messages" title="Permanent link">&para;</a></h4>
<p>A price request is sent containing the selected service_id.</p>
<p>The response from Thing B contains a list of price items; each item should contain a price_id, per unit price, unit_ID and description fields of both the unit and the price.</p>
<p>Thing A then selects an appropriate price_id by sending a request with its client_UUID, the selected service_id, the price_id, and the number of items required.</p>
<p>If the number of items falls within the correct number of items for the price selected, then Thing B responds with a price select response containing the service_id, price_id, the total price, the service_UUID and a reference for the payment and its Merchant Client key. Otherwise Thing B shall return the number of units it can supply along with the correct price, and additional details required to initiate the payment.</p>
<h4 id="payment">Payment<a class="headerlink" href="#payment" title="Permanent link">&para;</a></h4>
<p>The payment process with Online.worldpay.com is a two stage process, split between the consumer and merchant Things involved in the transaction, these stages are:</p>
<ul>
<li>Client Token Request, and</li>
<li>Payment Authorisation Request. (Also known as Order Request)</li>
</ul>
<p>During the first stage, the consumer sends Online.worldpay.com their payment credentials and the merchants Client Key. Online.worldpay.com returns a Client Token, which the consumer passes to the Merchant, allowing the merchant to perform the payment authorisation request with Online.worldpay.com by providing the Client Token and transaction details.</p>
<p>This payment process ensures that the consumer does not pass their payment credentials to the merchant, only to Online.worldpay.com.</p>
<h4 id="client-token-request">Client token request<a class="headerlink" href="#client-token-request" title="Permanent link">&para;</a></h4>
<p>The first step in the payment process is when Thing A receives the Merchant_Client_Key from Thing B. Thing B passes their public Client Key to Thing A as part of the price_select_response during the Service Negotiation phase. Upon receiving the Client Key from Thing B, Thing A connects with Online.worldpay.com to request the client token from Online.worldpay.com. This request includes Thing A’s payment credentials: Card PAN, expiry, and the client_key of Thing B. Online.worldpay.com will respond with a message that includes a client_token. This is shown in Figure 7.</p>
<p><img alt="IoT Payment process - client token request" src="../images/architecture/paymentProcessToken.png" />
<figcaption>Figure 7. IoT Payment process - client token request.</figcaption></p>
<h4 id="client-token-request-apis">Client token request APIs<a class="headerlink" href="#client-token-request-apis" title="Permanent link">&para;</a></h4>
<h5 id="thing-a-to-onlineworldpaycom-client-token-request">Thing A to Online.worldpay.com client token request<a class="headerlink" href="#thing-a-to-onlineworldpaycom-client-token-request" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Key</th>
<th>Parameters</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>client_token_request</td>
<td>Payment_method, reusable_flag, Merchant_client_key Payment_method (name, PAN, expiryMonth, expiryYear, type)</td>
<td>Request a client token from Online.worldpay.com, whilst providing Online.worldpay.com with the payment credentials.</td>
</tr>
<tr>
<td>client_token_response</td>
<td>client_token, reusable_flag, payment_method_response (type, name, expiryMonth, expiryYear, card_type, card_scheme_type, card_scheme_name, masked_card_number, card_product_type_description_non_contactless, card_product_type_description_contactless, card_issuer, country_code, card_class, pre-paid)</td>
<td>Response from Online.worldpay.com containing the client_token.</td>
</tr>
<tr>
<td>Payment_request</td>
<td>client_token, client_UUID, payment_ref_ID</td>
<td>The client_token is passed to Thing B to allow the 2<sup>nd</sup> part of the transaction process to take place.</td>
</tr>
</tbody>
</table>
<p>Thing A will connect to Online.worldpay.com using TLS. It will then request a client_token by securely (see 2.2.1) sending a JSON message containing the paymentMethod, its payment credentials (PAN, expiry) to Online.worldpay.com along with the client_ key from Thing B. In addition a flag indicating if the client details can be used in future is sent, for IoT this should always be set ‘reusable’:’false’ in order to force generation of a new client token for each transaction.</p>
<p>A successful response will be an HTTP POST response containing fields: client_token, reusable_flag and the payment_method_response. Once received, the client_token shall be passed to Thing B</p>
<p>A sample request is shown in Appendix B: Sample Service Messaging.</p>
<p>See Online.worldpay.com documentation for client_token_request &amp; client_token_repsonse APIs data descriptions.</p>
<h4 id="payment-authorisation-request">Payment authorisation request<a class="headerlink" href="#payment-authorisation-request" title="Permanent link">&para;</a></h4>
<p>Thing B will process the order and request the payment from Online.worldpay.com providing its Service key, client_token, transaction currency and payment amount. This is transmitted to Online.worldpay.com over TLS. After successful processing Online.worldpay.com will provide a payment response. Thing B shall then generate a service token, which Thing A may use in future to obtain the services that the payment has been made for. This is shown in Figure 7.</p>
<p><img alt="Payment Authorisation Request" src="../images/architecture/paymentAuthRequest.png" />
<figcaption>Figure 8. Payment Authorisation Request.</figcaption></p>
<h4 id="payment-authorisation-request-apis">Payment authorisation request APIs<a class="headerlink" href="#payment-authorisation-request-apis" title="Permanent link">&para;</a></h4>
<h5 id="thing-b-to-onlineworldpaycom-payment-authorisation-request">Thing B to Online.worldpay.com payment authorisation request<a class="headerlink" href="#thing-b-to-onlineworldpaycom-payment-authorisation-request" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Key</th>
<th>Parameters</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>order_request</td>
<td>client_service_key, client_token, currency_code, amount, order_description, customer_order_code</td>
<td>Request payment from Online.worldpay.com.</td>
</tr>
<tr>
<td>order_response</td>
<td>order_code, client_token, order_description, amount, currency_code, payment_status, customer_order_code, environment, risk_score, payment_response (type, name, expiryMonth, expiryYear, card_type, card_scheme_type, card_scheme_name, masked_card_number, card_product_type_description_non_contactless, card_product_type_description_contactless, card_issuer, country_code, card_class, pre-paid)</td>
<td>Payment response indicating a successful transaction on the Online.worldpay.com platform.</td>
</tr>
</tbody>
</table>
<p>Thing B shall assemble a message to be posted to Online.worldpay.com that contains the client token, Service key, the amount, currency and transaction description. Online.worldpay.com shall then perform an authorisation using the payment credentials identified by the client_token. A successful authorisation will result in a payment_status of SUCCESS being returned to Thing B.</p>
<h5 id="thing-b-to-thing-a-service-token">Thing B to Thing A service token<a class="headerlink" href="#thing-b-to-thing-a-service-token" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Key</th>
<th>Parameters</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>payment_request_response</td>
<td>service_delivery_token, server_UUID, client_UUID, total_paid</td>
<td>service_delivery_token is passed to ThingB.</td>
</tr>
</tbody>
</table>
<p>Thing B shall then generate a cryptographically secure service_delivery_token, which can be used by Thing A to request provision of services from Thing B.</p>
<h3 id="service-delivery">Service Delivery<a class="headerlink" href="#service-delivery" title="Permanent link">&para;</a></h3>
<p>Once the payment has been made, Thing B shall return to broadcasting its available services. Thing A will now be able to consume the service from Thing B by providing the service_delivery_token. The service delivery may be in a single step, or over time. An overview of service delivery is shown in Figure 8.</p>
<p><img alt="Service delivery" src="../images/architecture/serviceDelivery.png" />
<figcaption>Figure 8. Service delivery.</figcaption></p>
<p>Once in possession of a service_token, Thing A may then request the service be provided. The service could be consumed in one session, or in several sessions over time, depending on the nature of the service and number of units purchased. Thing A may repeatedly send service delivery requests until Thing B indicates that the service has been delivered.</p>
<h4 id="service-delivery-apis">Service Delivery APIs<a class="headerlink" href="#service-delivery-apis" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Key</th>
<th>Parameters</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>payment_request_response</td>
<td>service_delivery_token, server_UUID, client_UUID, total_paid</td>
<td>service_delivery_token is passed to ThingB.</td>
</tr>
<tr>
<td>broadcast</td>
<td>server_UUID</td>
<td>Advertising services and identifying the sender.</td>
</tr>
<tr>
<td>delivery_begin_request</td>
<td>service_delivery_token, client_UUID, number_of_units_to_supply</td>
<td>Request the service item, with the service_delivery_token providing right to receive the service, and amount of service to be supplied.</td>
</tr>
<tr>
<td>delivery_begin_response</td>
<td>server_UUID, service_delivery_token, client_UUID, number_of_units_to_be_supplied</td>
<td>Response for the service delivery. Confirmation of number of service units to be supplied (Allowing for less units than requested).</td>
</tr>
<tr>
<td>delivery_end</td>
<td>client_UUID, number_of_units_received</td>
<td>Confirmation of service received.</td>
</tr>
<tr>
<td>delivery_end_response</td>
<td>server_UUID, service_delivery_token, client_UUID, number_of_units_just_supplied, number_of_units_remaining</td>
<td>Service end indicating outstanding service credits and token for subsequent delivery.</td>
</tr>
</tbody>
</table>
<p>Thing A sends a message with the service_delivery_token to Thing B, along with the amount of service it wishes to consume. The response shall confirm the amount of service units that Thing B can supply to Thing A at that time. Once the service has been delivered, Thing A shall confirm the amount of service units it has received, with Thing B responding, stating the number of units still remaining to Thing A, if any.</p>
<h2 id="useful-terms">Useful terms<a class="headerlink" href="#useful-terms" title="Permanent link">&para;</a></h2>
<p>A few useful terms we're making quite a lot of use of, and if you are new to the world of payments these may be unfamiliar to you!</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td>API</td>
<td>Application Programming Interface</td>
</tr>
<tr>
<td>Online.worldpay.com</td>
<td>Worldpay Open Payment API, <a href="https://online.worldpay.com/"><a href="https://online.worldpay.com/">https://online.worldpay.com/</a></a></td>
</tr>
<tr>
<td>HCE</td>
<td>Host Card Emulation</td>
</tr>
<tr>
<td>HTE</td>
<td>Host Terminal Emulation</td>
</tr>
<tr>
<td>HTTPS</td>
<td>HyperText Transfer Protocol Secure</td>
</tr>
<tr>
<td>IoT</td>
<td>Internet of Things</td>
</tr>
<tr>
<td>P2PE</td>
<td>Point to Point Encryption</td>
</tr>
<tr>
<td>TLS</td>
<td>Transport Layer Security</td>
</tr>
<tr>
<td>UUID</td>
<td>Universally Unique Identifier</td>
</tr>
<tr>
<td>RPC</td>
<td>Remote Procedure Call</td>
</tr>
</tbody>
</table>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../the-flows/" title="The Flows" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                The Flows
              </span>
            </div>
          </a>
        
        
          <a href="../atdc/" title="The Atlanta Fintech Hackathon" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                The Atlanta Fintech Hackathon
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-18486c15f8.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","None","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>